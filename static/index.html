<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente de Pesquisa Acadêmica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter e Material Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-container, .screen { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .hidden-screen { display: none; }
        .read-row { background-color: #f0fdf4; }
        .read-row:hover { background-color: #dcfce7; }
        #detailsModalContent ul, #frameworkContent ul { list-style: none; padding: 0; }
        #detailsModalContent li, #frameworkContent li { display: flex; flex-direction: column; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
        #detailsModalContent li:last-child, #frameworkContent li:last-child { border-bottom: none; }
        #detailsModalContent li strong, #frameworkContent h3 { color: #374151; margin-bottom: 0.25rem; }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="p-4 sm:p-8 min-h-screen">
        <!-- Telas -->
        <div id="dashboardScreen" class="screen w-full max-w-2xl mx-auto text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-2">Agente de Pesquisa Acadêmica</h1>
            <p class="text-gray-500 mb-12">Seu assistente para a construção do referencial teórico.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="newSearchCard" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border"><span class="material-icons text-5xl text-blue-500 mb-4">search</span><h2 class="text-xl font-semibold">Nova Busca</h2><p class="text-gray-500 mt-1">Encontre novos artigos.</p></div>
                <div id="manageCard" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border"><span class="material-icons text-5xl text-purple-500 mb-4">inventory_2</span><h2 class="text-xl font-semibold">Gerenciar Fichamentos</h2><p class="text-gray-500 mt-1">Organize seus artigos.</p></div>
            </div>
        </div>
        <div id="loadingScreen" class="screen hidden-screen w-full text-center py-20"><div class="flex justify-center items-center"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div></div><p class="text-gray-600 mt-4 text-lg">Processando...</p></div>
        <div id="resultsScreen" class="screen hidden-screen w-full max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg border"><div class="p-4 sm:p-6 border-b flex justify-between items-center gap-4"><div class="flex items-center gap-4"><button id="backToHomeButton" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons">arrow_back</span></button><div><h2 class="text-2xl font-bold">Resultados da Busca</h2><p id="searchQueryDisplay" class="text-sm text-gray-500 mt-1"></p><p id="resultsCounter" class="text-sm text-gray-500"></p></div></div><button id="generateButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center disabled:bg-gray-400" disabled><span class="material-icons mr-2">description</span>Gerar Fichamento (0)</button></div><div class="p-4 flex justify-between items-center border-b bg-gray-50"><div class="flex items-center"><input type="checkbox" id="selectAllCheckbox" class="h-5 w-5 rounded border-gray-300 text-blue-600"><label for="selectAllCheckbox" class="ml-3 text-sm font-medium">Selecionar Todos</label></div><div class="flex items-center gap-2"><label for="sortOrder" class="text-sm font-medium">Ordenar por:</label><select id="sortOrder" class="rounded-lg border-gray-300 text-sm"><option value="relevance">Relevância</option><option value="citations">Mais Citados</option><option value="recent">Mais Recentes</option></select></div></div><div id="articlesList" class="divide-y"></div><div id="pagination" class="p-4 text-center border-t"><button id="loadMoreButton" class="bg-white border border-gray-300 font-semibold py-2 px-6 rounded-lg hover:bg-gray-50 disabled:bg-gray-200">Carregar Mais</button></div></div>
        </div>
        <div id="manageScreen" class="screen hidden-screen w-full max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg border"><div class="p-4 sm:p-6 border-b flex justify-between items-center gap-4 flex-wrap"><div class="flex items-center gap-4"><button id="backToHomeFromManageButton" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons">arrow_back</span></button><div><h2 class="text-2xl font-bold">Gerenciar Fichamentos</h2><p class="text-gray-500">Organize seus artigos salvos.</p></div></div><div class="flex gap-4"><button id="addByLinkCard" class="bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-50 flex items-center"><span class="material-icons mr-2">link</span>Adicionar por Link</button><button id="buildFrameworkButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed"><span class="material-icons mr-2">build</span>Construir Referencial</button></div></div><div class="p-4 flex flex-col sm:flex-row items-center gap-4 border-b bg-gray-50"><span class="font-medium text-sm">Filtrar por:</span><select id="filterStatus" class="filter-select rounded-lg border-gray-300 text-sm"><option value="all">Status (Todos)</option><option value="read">Lido</option><option value="unread">Não Lido</option></select><select id="filterYear" class="filter-select rounded-lg border-gray-300 text-sm"><option value="all">Ano (Todos)</option></select><select id="filterTopic" class="filter-select rounded-lg border-gray-300 text-sm"><option value="all">Tópico (Todos)</option></select></div><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-gray-50"><tr><th class="px-6 py-3 whitespace-nowrap">Status</th><th class="px-6 py-3">Título</th><th class="px-6 py-3">Tópico</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="manageTableBody"></tbody></table></div></div>
        </div>
        <div id="frameworkScreen" class="screen hidden-screen w-full max-w-4xl mx-auto">
             <div class="bg-white rounded-2xl shadow-lg border border-gray-100"><div class="p-4 sm:p-6 border-b flex justify-between items-center gap-4"><div class="flex items-center gap-4"><button id="backToManageButton" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><span class="material-icons">arrow_back</span></button><div><h2 class="text-2xl font-bold text-gray-800">Referencial Teórico</h2><p class="text-gray-500">Artigos agrupados por objetivo específico.</p></div></div><button id="copyFrameworkButton" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center"><span class="material-icons mr-2">content_copy</span>Copiar Tudo</button></div><div id="frameworkContent" class="p-4 sm:p-6"></div></div>
        </div>

        <!-- Modals -->
        <div id="searchModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Configurar Nova Busca</h2><button data-modal-target="search" class="close-modal text-gray-400"><span class="material-icons">close</span></button></div><div><div class="mb-6"><label class="block text-md font-medium mb-2">Tipo de Operação</label><div class="grid grid-cols-1 md:grid-cols-3 gap-2 rounded-lg bg-gray-100 p-1"><label><input type="radio" name="operationType" value="ia" class="hidden peer" checked><div class="peer-checked:bg-white peer-checked:shadow text-center p-2 rounded-md cursor-pointer">Busca IA</div></label><label><input type="radio" name="operationType" value="direct" class="hidden peer"><div class="peer-checked:bg-white peer-checked:shadow text-center p-2 rounded-md cursor-pointer">Busca Direta</div></label><label><input type="radio" name="operationType" value="import" class="hidden peer"><div class="peer-checked:bg-white peer-checked:shadow text-center p-2 rounded-md cursor-pointer">Importar Ficheiro</div></label></div></div><div id="search-inputs-container"><div class="mb-6"><textarea id="mainSearchInput" rows="3" class="w-full p-3 border rounded-lg"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8"><div><label class="block text-sm font-medium mb-1">Ano a partir de</label><input type="number" id="minYear" class="w-full p-3 border rounded-lg" value="2020"></div><div><label class="block text-sm font-medium mb-1">Mínimo de citações</label><input type="number" id="minCitations" class="w-full p-3 border rounded-lg" value="10"></div></div></div><div id="import-inputs-container" class="hidden"><div class="mb-6"><label for="bibFileInput" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 flex items-center justify-center cursor-pointer"><span class="material-icons mr-2">file_upload</span>Selecionar Ficheiro .bib</label><input type="file" id="bibFileInput" class="hidden" accept=".bib"><p id="fileNameDisplay" class="text-sm text-center text-gray-500 mt-2"></p></div></div><button id="mainActionButton" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg"><span class="material-icons mr-2">search</span>Buscar Artigos</button></div></div></div>
        <div id="addByLinkModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Adicionar Artigo por Link</h2><button data-modal-target="addByLink" class="close-modal text-gray-400"><span class="material-icons">close</span></button></div><div><div class="mb-6"><label for="urlInput" class="block text-md font-medium mb-2">URL do Artigo (ResearchGate)</label><textarea id="urlInput" rows="3" class="w-full p-3 border rounded-lg" placeholder="Cole aqui o link do artigo do ResearchGate..."></textarea></div><button id="addByLinkActionButton" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg"><span class="material-icons mr-2">add_circle</span>Adicionar Artigo</button></div></div></div>
        
        <div id="summaryModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Resumo Analítico (IA)</h3><button data-modal-target="summary" class="close-modal text-gray-400"><span class="material-icons">close</span></button></div><div id="summaryModalContent" class="prose"></div></div></div>
        <div id="confirmDeleteModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center"><h3 class="text-xl font-bold mb-4">Confirmar Exclusão</h3><p class="mb-6">Tem certeza?</p><div class="flex justify-center gap-4"><button id="cancelDeleteButton" class="px-6 py-2 rounded-lg border">Cancelar</button><button id="confirmDeleteButton" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold">Excluir</button></div></div></div>
        <div id="detailsModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Detalhes e Anotações</h3><button data-modal-target="details" class="close-modal text-gray-400"><span class="material-icons">close</span></button></div><div id="detailsModalContent"></div><div class="mt-6 text-right"><button id="saveDetailsButton" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold">Salvar</button></div></div></div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let currentArticles = [], savedArticles = [], displayedCount = 0, rowToDelete = null, articleToEdit = null;
        const articlesPerPage = 5;
        let currentSearchTerm = '';
        let selectedArticleIds = new Set();
        
        const dom = {
            screens: { dashboard: document.getElementById('dashboardScreen'), loading: document.getElementById('loadingScreen'), results: document.getElementById('resultsScreen'), manage: document.getElementById('manageScreen'), framework: document.getElementById('frameworkScreen') },
            modals: { search: document.getElementById('searchModal'), summary: document.getElementById('summaryModal'), confirmDelete: document.getElementById('confirmDeleteModal'), details: document.getElementById('detailsModal'), addByLink: document.getElementById('addByLinkModal') },
            newSearchCard: document.getElementById('newSearchCard'), manageCard: document.getElementById('manageCard'), closeModalButtons: document.querySelectorAll('.close-modal'), startSearchButton: document.getElementById('startSearchButton'), backToHomeButton: document.getElementById('backToHomeButton'), backToHomeFromManageButton: document.getElementById('backToHomeFromManageButton'), backToManageButton: document.getElementById('backToManageButton'),
            manageTableBody: document.getElementById('manageTableBody'), summaryModalContent: document.getElementById('summaryModalContent'), detailsModalContent: document.getElementById('detailsModalContent'), cancelDeleteButton: document.getElementById('cancelDeleteButton'), confirmDeleteButton: document.getElementById('confirmDeleteButton'), saveDetailsButton: document.getElementById('saveDetailsButton'),
            filterStatus: document.getElementById('filterStatus'), filterYear: document.getElementById('filterYear'), filterTopic: document.getElementById('filterTopic'),
            articlesList: document.getElementById('articlesList'), selectAllCheckbox: document.getElementById('selectAllCheckbox'), generateButton: document.getElementById('generateButton'), sortOrder: document.getElementById('sortOrder'), loadMoreButton: document.getElementById('loadMoreButton'), resultsCounter: document.getElementById('resultsCounter'), mainSearchInput: document.getElementById('mainSearchInput'), searchTypeRadios: document.querySelectorAll('input[name="searchType"]'),
            buildFrameworkButton: document.getElementById('buildFrameworkButton'), frameworkContent: document.getElementById('frameworkContent'), copyFrameworkButton: document.getElementById('copyFrameworkButton'),
            addByLinkCard: document.getElementById('addByLinkCard'), addByLinkActionButton: document.getElementById('addByLinkActionButton'), urlInput: document.getElementById('urlInput'),
            searchQueryDisplay: document.getElementById('searchQueryDisplay'),
            operationTypeRadios: document.querySelectorAll('input[name="operationType"]'),
            mainActionButton: document.getElementById('mainActionButton'),
            searchInputContainer: document.getElementById('search-inputs-container'),
            importInputsContainer: document.getElementById('import-inputs-container'),
            bibFileInput: document.getElementById('bibFileInput'),
            fileNameDisplay: document.getElementById('fileNameDisplay')
        };
        const showScreen = name => { Object.values(dom.screens).forEach(s => s.classList.add('hidden-screen')); dom.screens[name].classList.remove('hidden-screen');};
        const openModal = name => { dom.modals[name].classList.remove('invisible', 'opacity-0'); dom.modals[name].querySelector('div > div').classList.remove('scale-95'); };
        const closeModal = name => { if (dom.modals[name]) { dom.modals[name].classList.add('opacity-0'); dom.modals[name].querySelector('div > div').classList.add('scale-95'); setTimeout(() => dom.modals[name].classList.add('invisible'), 300); } };
        
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                dom.screens.loading.classList.remove('hidden-screen');
                const options = { method };
                if (body instanceof FormData) { options.body = body; } 
                else if (body) { options.headers = { 'Content-Type': 'application/json' }; options.body = JSON.stringify(body); }
                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                alert(`Erro de comunicação com o servidor. Verifique o console do navegador e o terminal do Python.`);
                showScreen('dashboard');
                return null;
            } finally {
                dom.screens.loading.classList.add('hidden-screen');
            }
        }
        
        const sortArticles = () => { const sortBy = dom.sortOrder.value; currentArticles.sort((a, b) => {if (sortBy === 'recent') return (b.year || 0) - (a.year || 0); if (sortBy === 'citations') return (b.citations || 0) - (a.citations || 0); if (sortBy === 'relevance') { const currentYear = new Date().getFullYear(); const getRecencyFactor = (year) => { const age = currentYear - (year || currentYear); if (age <= 1) return 1.5; if (age <= 3) return 1.2; return 1; }; return ((b.citations || 0) * getRecencyFactor(b.year)) - ((a.citations || 0) * getRecencyFactor(a.year)); } return 0; }); };
        const renderSearchResults = () => { sortArticles(); dom.articlesList.innerHTML = ''; const articlesToRender = currentArticles.slice(0, displayedCount); articlesToRender.forEach(article => { const articleElement = document.createElement('div'); articleElement.className = 'p-4 sm:p-6 flex items-start gap-4'; const isChecked = selectedArticleIds.has(article.id) ? 'checked' : ''; articleElement.innerHTML = `<div class="flex-shrink-0 mt-1"><input type="checkbox" data-id="${article.id}" class="article-checkbox h-5 w-5 rounded border-gray-300 text-blue-600" ${isChecked}></div><div class="flex-grow"><p class="text-lg font-semibold text-gray-800">${article.title}</p><p class="text-sm text-gray-500 mt-1">${(article.authors || []).join(', ')}</p><div class="flex items-center gap-4 text-sm text-gray-600 mt-2"><span><strong>Ano:</strong> ${article.year || 'N/A'}</span><span class="text-gray-300">|</span><span><strong>Fonte:</strong> ${article.source}</span><span class="text-gray-300">|</span><span><strong>Citações:</strong> ${article.citations || 0}</span></div></div><div class="flex-shrink-0 ml-4"><a href="${article.url}" target="_blank" class="p-2 rounded-full hover:bg-gray-100" title="Ver artigo original"><span class="material-icons">open_in_new</span></a></div>`; dom.articlesList.appendChild(articleElement); }); document.querySelectorAll('.article-checkbox').forEach(cb => cb.addEventListener('change', updateSelectionState)); updateCounter(); updateSelectionState(); };
        const updateCounter = () => { dom.resultsCounter.textContent = `Mostrando ${Math.min(displayedCount, currentArticles.length)} de ${currentArticles.length} artigos.`; dom.loadMoreButton.disabled = displayedCount >= currentArticles.length; };
        const updateSelectionState = (e) => { if(e) { const checkbox = e.target; if (checkbox.checked) { selectedArticleIds.add(checkbox.dataset.id); } else { selectedArticleIds.delete(checkbox.dataset.id); } } const count = selectedArticleIds.size; dom.generateButton.disabled = count === 0; dom.generateButton.innerHTML = `<span class="material-icons mr-2">description</span> Gerar Fichamento (${count})`; if (count === 0) { dom.selectAllCheckbox.checked = false; dom.selectAllCheckbox.indeterminate = false; } else if (count === currentArticles.length) { dom.selectAllCheckbox.checked = true; dom.selectAllCheckbox.indeterminate = false; } else { dom.selectAllCheckbox.checked = false; dom.selectAllCheckbox.indeterminate = true; } };
        const handleSelectAll = (event) => { if (event.target.checked) { currentArticles.forEach(a => selectedArticleIds.add(a.id)); } else { selectedArticleIds.clear(); } renderSearchResults(); };
        const handleStartSearch = async () => { closeModal('search'); currentSearchTerm = dom.mainSearchInput.value; const payload = { searchType: document.querySelector('input[name="searchType"]:checked').value, queryText: currentSearchTerm, minYear: document.getElementById('minYear').value, minCitations: document.getElementById('minCitations').value, }; selectedArticleIds.clear(); const articles = await apiCall('/api/search', 'POST', payload); if (articles) { currentArticles = articles; displayedCount = articlesPerPage; dom.searchQueryDisplay.textContent = `Busca por: "${currentSearchTerm}"`; renderSearchResults(); showScreen('results'); } };
        const handleLoadMore = () => { displayedCount += articlesPerPage; renderSearchResults(); };
        const handleGenerateFichamentos = async () => { const articlesToGenerate = currentArticles.filter(a => selectedArticleIds.has(a.id)); dom.generateButton.disabled = true; dom.generateButton.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>`; const result = await apiCall('/api/generate', 'POST', { articles: articlesToGenerate }); if (result) { alert(result.message); currentArticles = currentArticles.filter(a => !selectedArticleIds.has(a.id)); selectedArticleIds.clear(); displayedCount = Math.min(displayedCount, currentArticles.length); renderSearchResults(); } dom.generateButton.disabled = false; updateSelectionState(); };
        
        const populateFilters = () => { const years = [...new Set(savedArticles.map(a => a.year))].sort((a,b) => b-a); const topics = [...new Set(savedArticles.map(a => a.topic))]; dom.filterYear.innerHTML = '<option value="all">Ano (Todos)</option>'; dom.filterTopic.innerHTML = '<option value="all">Tópico (Todos)</option>'; years.forEach(y => dom.filterYear.innerHTML += `<option value="${y}">${y}</option>`); topics.forEach(t => dom.filterTopic.innerHTML += `<option value="${t}">${t}</option>`); };
        const renderManageTable = () => {
            populateFilters(); 
            const canBuild = savedArticles.some(a => a.read && a.specificObjective);
            dom.buildFrameworkButton.disabled = !canBuild;
            dom.manageTableBody.innerHTML = ''; 
            const filteredArticles = savedArticles.filter(a => (dom.filterStatus.value === 'all' || (dom.filterStatus.value === 'read' && a.read) || (dom.filterStatus.value === 'unread' && !a.read)) && (dom.filterYear.value === 'all' || a.year == dom.filterYear.value) && (dom.filterTopic.value === 'all' || a.topic == dom.filterTopic.value)); 
            filteredArticles.forEach(article => { const row = document.createElement('tr'); row.className = `bg-white border-b ${article.read ? 'read-row' : ''}`; row.dataset.id = article.id; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${article.read ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${article.read ? 'Lido' : 'Não Lido'}</span></td><td class="px-6 py-4 font-medium text-gray-900">${article.title}</td><td class="px-6 py-4">${article.topic}</td><td class="px-6 py-4 text-center"><div class="flex justify-center items-center gap-1"><button class="toggle-read p-2" title="Marcar"><span class="material-icons">visibility</span></button><button class="view-summary p-2" title="Ver resumo"><span class="material-icons">info</span></button><button class="view-details p-2" title="Ver detalhes"><span class="material-icons">article</span></button><button class="delete-row p-2" title="Excluir"><span class="material-icons">delete_outline</span></button></div></td>`; dom.manageTableBody.appendChild(row); }); 
        };
        const handleManageTableClick = e => { const button = e.target.closest('button'); if (!button) return; const row = e.target.closest('tr'); articleToEdit = savedArticles.find(a => a.id === row.dataset.id); if (!articleToEdit) return; if (button.classList.contains('toggle-read')) { articleToEdit.read = !articleToEdit.read; articleToEdit.readDate = articleToEdit.read ? new Date().toISOString().split('T')[0] : null; renderManageTable(); apiCall('/api/manage/update', 'POST', { articles: savedArticles }); } else if (button.classList.contains('view-summary')) { dom.summaryModalContent.textContent = articleToEdit.summary; openModal('summary'); } else if (button.classList.contains('view-details')) { dom.detailsModalContent.innerHTML = `<ul><li><strong>Autores:</strong> <span>${(articleToEdit.authors||[]).join(', ')}</span></li><li><strong>Ano:</strong> <span>${articleToEdit.year}</span></li><li><strong>Citações:</strong> <span>${articleToEdit.citations}</span></li><li><strong>Data de Seleção:</strong> <span>${articleToEdit.selectionDate}</span></li><li><strong>Data de Leitura:</strong> <span>${articleToEdit.readDate || 'Não lido'}</span></li><li><strong>Link:</strong> <a href="${articleToEdit.url}" target="_blank" class="text-blue-600">Ver original</a></li></ul><hr class="my-4"><div><label class="block font-medium mb-2">Objetivo Específico</label><textarea id="specificObjective" rows="3" class="w-full p-2 border rounded-lg">${articleToEdit.specificObjective || ''}</textarea></div>`; openModal('details'); } else if (button.classList.contains('delete-row')) { rowToDelete = row; openModal('confirmDelete'); } };
        const saveDetails = async () => { if(articleToEdit) articleToEdit.specificObjective = document.getElementById('specificObjective').value; await apiCall('/api/manage/update', 'POST', { articles: savedArticles }); closeModal('details'); renderManageTable(); };
        const executeDelete = async () => { if (rowToDelete) { savedArticles = savedArticles.filter(a => a.id !== rowToDelete.dataset.id); await apiCall('/api/manage/update', 'POST', { articles: savedArticles }); renderManageTable(); } closeModal('confirmDelete'); };
        const loadManageScreen = async () => { showScreen('loading'); const data = await apiCall('/api/manage/load'); if (data !== null) { savedArticles = data; renderManageTable(); showScreen('manage'); } };
        const handleBuildFramework = async () => { showScreen('loading'); const data = await apiCall('/api/build-framework'); if (data) { dom.frameworkContent.innerHTML = ''; if (Object.keys(data).length === 0) { dom.frameworkContent.innerHTML = '<p class="text-gray-500">Nenhum artigo lido com objetivo específico encontrado. Marque alguns artigos como "Lido" e adicione um objetivo para começar.</p>'; } else { for (const objective in data) { const section = document.createElement('div'); section.className = 'mb-8'; let referencesHTML = data[objective].map(ref => `<li class="text-gray-700 leading-relaxed p-2 bg-gray-50 rounded-md flex justify-between items-center"><span>${ref}</span><button class="copy-ref p-1 text-gray-400 hover:text-blue-600" title="Copiar referência"><span class="material-icons text-base">content_copy</span></button></li>`).join(''); section.innerHTML = `<details class="bg-white p-4 rounded-lg shadow-sm" open><summary class="font-semibold text-lg cursor-pointer">${objective}</summary><ul class="space-y-3 mt-4">${referencesHTML}</ul></details>`; dom.frameworkContent.appendChild(section); } } showScreen('framework'); } };
        const handleFrameworkClick = (e) => { const copyButton = e.target.closest('.copy-ref'); if (copyButton) { const textToCopy = copyButton.parentElement.querySelector('span').innerText; navigator.clipboard.writeText(textToCopy).then(() => alert('Referência copiada!'), () => alert('Falha ao copiar.')); } else if (e.target.tagName !== 'SUMMARY') { e.preventDefault(); } };
        const updatePlaceholder = () => { dom.mainSearchInput.placeholder = document.querySelector('input[name="operationType"]:checked').value === 'ia' ? "Digite sua pergunta de pesquisa ou objetivo..." : "Digite os termos de busca (ex: 'user experience' AND 'SME')..."; };
        const handleAddByLink = async () => { const url = dom.urlInput.value; if (!url) { alert('Por favor, insira uma URL.'); return; } closeModal('addByLink'); const result = await apiCall('/api/add-by-url', 'POST', { url }); if (result) { alert(result.message); if (result.status === 'success') { loadManageScreen(); } else { showScreen('dashboard'); } } };
        const handleOperationTypeChange = () => {
            const selectedValue = document.querySelector('input[name="operationType"]:checked').value;
            if (selectedValue === 'import') {
                dom.searchInputContainer.classList.add('hidden');
                dom.importInputsContainer.classList.remove('hidden');
                dom.mainActionButton.innerHTML = `<span class="material-icons mr-2">publish</span>Processar Ficheiro`;
            } else {
                dom.searchInputContainer.classList.remove('hidden');
                dom.importInputsContainer.classList.add('hidden');
                dom.mainActionButton.innerHTML = `<span class="material-icons mr-2">search</span>Buscar Artigos`;
                updatePlaceholder();
            }
        };
        const handleBibFileSelect = (event) => {
            const file = event.target.files[0];
            if (file) {
                dom.fileNameDisplay.textContent = file.name;
                dom.mainActionButton.disabled = false;
            }
        };
        const handleMainAction = async () => {
            const selectedValue = document.querySelector('input[name="operationType"]:checked').value;
            if (selectedValue === 'import') {
                const file = dom.bibFileInput.files[0];
                if (!file) { alert("Por favor, selecione um ficheiro .bib"); return; }
                const formData = new FormData();
                formData.append('file', file);
                closeModal('search');
                const articles = await apiCall('/api/import-bib', 'POST', formData);
                if (articles) {
                    currentArticles = articles;
                    displayedCount = articlesPerPage;
                    dom.searchQueryDisplay.textContent = `Artigos importados de ${file.name}`;
                    renderSearchResults();
                    showScreen('results');
                }
            } else {
                handleStartSearch();
            }
        };

        // EVENT LISTENERS
        dom.newSearchCard.addEventListener('click', () => openModal('search'));
        dom.manageCard.addEventListener('click', loadManageScreen);
        dom.buildFrameworkButton.addEventListener('click', handleBuildFramework); 
        dom.backToManageButton.addEventListener('click', () => showScreen('manage')); 
        dom.closeModalButtons.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('button').dataset.modalTarget)));
        dom.generateButton.addEventListener('click', handleGenerateFichamentos);
        dom.backToHomeButton.addEventListener('click', () => showScreen('dashboard'));
        dom.backToHomeFromManageButton.addEventListener('click', () => showScreen('dashboard'));
        dom.manageTableBody.addEventListener('click', handleManageTableClick);
        dom.saveDetailsButton.addEventListener('click', saveDetails);
        dom.confirmDeleteButton.addEventListener('click', executeDelete);
        dom.cancelDeleteButton.addEventListener('click', () => closeModal('confirmDelete'));
        document.querySelectorAll('.filter-select').forEach(sel => sel.addEventListener('change', renderManageTable));
        dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
        dom.sortOrder.addEventListener('change', renderSearchResults);
        dom.loadMoreButton.addEventListener('click', handleLoadMore);
        dom.operationTypeRadios.forEach(radio => radio.addEventListener('change', handleOperationTypeChange));
        dom.mainActionButton.addEventListener('click', handleMainAction);
        dom.bibFileInput.addEventListener('change', handleBibFileSelect);
        dom.copyFrameworkButton.addEventListener('click', (e) => { e.stopPropagation(); const text = dom.frameworkContent.innerText; navigator.clipboard.writeText(text).then(() => alert('Referencial copiado!'), () => alert('Falha ao copiar.')); });
        dom.frameworkContent.addEventListener('click', handleFrameworkClick);
        dom.addByLinkCard.addEventListener('click', () => openModal('addByLink'));
        dom.addByLinkActionButton.addEventListener('click', handleAddByLink);
        
        showScreen('dashboard');
        updatePlaceholder();
    </script>
</body>
</html>
